name: Daily Agent Builder

on:
  schedule:
    # Run daily at 9:00 AM UTC (adjust timezone as needed)
    # Format: minute hour day month day-of-week
    - cron: '0 9 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-agent:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # Fetch all history for git operations
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
    
    - name: Install dependencies
      working-directory: ./agent-builder-agent
      run: |
        # Ensure virtual environment is created and dependencies are installed
        uv venv
        uv sync
        # Verify dotenv is installed
        echo "Checking installed packages:"
        uv pip list | head -20
    
    - name: Run Agent Builder
      working-directory: ./agent-builder-agent
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'gpt-4o' }}
        SMTP_SERVER: ${{ secrets.SMTP_SERVER || 'smtp.gmail.com' }}
        SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
        SMTP_USER: ${{ secrets.SMTP_USER }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
        GITHUB_REPO_URL: ${{ secrets.GITHUB_REPO_URL }}
        DAILY_RUN_TIME: ${{ secrets.DAILY_RUN_TIME || '09:00' }}
        # Configure git for commits
        GIT_AUTHOR_NAME: ${{ secrets.GIT_AUTHOR_NAME || 'Agent Builder' }}
        GIT_AUTHOR_EMAIL: ${{ secrets.GIT_AUTHOR_EMAIL || 'agent-builder@noreply.github.com' }}
        GIT_COMMITTER_NAME: ${{ secrets.GIT_COMMITTER_NAME || 'Agent Builder' }}
        GIT_COMMITTER_EMAIL: ${{ secrets.GIT_COMMITTER_EMAIL || 'agent-builder@noreply.github.com' }}
      run: |
        git config --global user.name "$GIT_AUTHOR_NAME"
        git config --global user.email "$GIT_AUTHOR_EMAIL"
        export GITHUB_REPO_URL="${GITHUB_REPO_URL:-https://github.com/${{ github.repository }}}"
        # Activate the virtual environment and verify it's working
        source .venv/bin/activate
        echo "Python path: $(which python)"
        echo "Python version: $(python --version)"
        python -c "import dotenv; print('✓ dotenv imported successfully')" || echo "✗ dotenv import failed"
        python main.py
    
    - name: Commit and push changes
      if: always()  # Run even if previous step failed
      run: |
        git config --global user.name "${{ secrets.GIT_AUTHOR_NAME || 'Agent Builder' }}"
        git config --global user.email "${{ secrets.GIT_AUTHOR_EMAIL || 'agent-builder@noreply.github.com' }}"
        git add .
        git diff --staged --quiet || git commit -m "Auto-update: Agent Builder run $(date +'%Y-%m-%d %H:%M:%S')"
        git push || echo "No changes to push or push failed"

